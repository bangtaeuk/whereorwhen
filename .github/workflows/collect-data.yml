name: Collect Travel Data

on:
  schedule:
    # 매일 03:00 UTC (12:00 KST) — 환율 + 점수 + 오늘의 BEST
    - cron: "0 3 * * *"
    # 6시간마다 예보 수집 — 21:00 UTC (06:00 KST), 09:00 UTC (18:00 KST), 15:00 UTC (00:00 KST)
    - cron: "0 9,15,21 * * *"
  workflow_dispatch:
    inputs:
      full_refresh:
        description: "Run all collectors (weather, holidays, trend) in addition to daily tasks"
        required: false
        default: "false"
        type: boolean

env:
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      # ── Always: collect forecasts (every 6h + daily) ───────
      - name: Collect forecasts (20 cities)
        run: npx tsx src/scripts/collect-forecast.ts

      # ── Daily (03:00 UTC only): exchange rates ─────────────
      - name: Collect exchange rates
        if: github.event.schedule == '0 3 * * *' || github.event_name == 'workflow_dispatch'
        run: npx tsx src/scripts/collect-exchange.ts
        env:
          EXCHANGE_RATE_API_KEY: ${{ secrets.EXCHANGE_RATE_API_KEY }}

      # ── Monthly (1st): trend collection ─────────────────────
      - name: Collect trend data (monthly)
        if: >-
          github.event_name == 'workflow_dispatch' && inputs.full_refresh == 'true' ||
          github.event.schedule == '0 3 * * *'
        run: |
          DAY=$(date -u +%d)
          if [ "$DAY" = "01" ] || [ "${{ inputs.full_refresh }}" = "true" ]; then
            npx tsx src/scripts/collect-trend.ts
          else
            echo "Skipping trend — not 1st of month"
          fi
        env:
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}

      # ── Yearly / manual: weather + holidays ────────────────
      - name: Collect weather data (yearly / manual)
        if: >-
          github.event_name == 'workflow_dispatch' && inputs.full_refresh == 'true'
        run: npx tsx src/scripts/collect-weather.ts

      - name: Collect holidays (yearly / manual)
        if: >-
          github.event_name == 'workflow_dispatch' && inputs.full_refresh == 'true'
        run: npx tsx src/scripts/collect-holidays.ts

      # ── Daily (03:00 UTC only): recalculate scores + today best
      - name: Calculate scores
        if: github.event.schedule == '0 3 * * *' || github.event_name == 'workflow_dispatch'
        run: npx tsx src/scripts/calculate-scores.ts

      - name: Calculate today's BEST
        if: github.event.schedule == '0 3 * * *' || github.event_name == 'workflow_dispatch'
        run: npx tsx src/scripts/calculate-today-best.ts

  # ── Manual-only: backfill historical exchange rates ────────
  backfill-exchange:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Backfill exchange rates
        run: npx tsx src/scripts/backfill-exchange.ts
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EXCHANGE_RATE_API_KEY: ${{ secrets.EXCHANGE_RATE_API_KEY }}
