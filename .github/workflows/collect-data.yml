name: Collect Travel Data

on:
  schedule:
    # 매일 03:00 UTC (12:00 KST)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      full_refresh:
        description: "Run all collectors (weather, holidays, trend) in addition to daily tasks"
        required: false
        default: "false"
        type: boolean

env:
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      # ── Daily: exchange rates (always) ─────────────────────
      - name: Collect exchange rates
        run: npx tsx src/scripts/collect-exchange.ts
        env:
          EXCHANGE_RATE_API_KEY: ${{ secrets.EXCHANGE_RATE_API_KEY }}

      # ── Monthly (1st): trend collection ─────────────────────
      - name: Collect trend data (monthly)
        if: >-
          github.event_name == 'workflow_dispatch' && inputs.full_refresh == 'true' ||
          (github.event_name == 'schedule' && github.run_number != '' && startsWith(github.event.schedule, '0 3'))
        run: |
          DAY=$(date -u +%d)
          if [ "$DAY" = "01" ] || [ "${{ inputs.full_refresh }}" = "true" ]; then
            npx tsx src/scripts/collect-trend.ts
          else
            echo "Skipping trend — not 1st of month"
          fi
        env:
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}

      # ── Yearly / manual: weather + holidays ────────────────
      - name: Collect weather data (yearly / manual)
        if: >-
          github.event_name == 'workflow_dispatch' && inputs.full_refresh == 'true'
        run: npx tsx src/scripts/collect-weather.ts

      - name: Collect holidays (yearly / manual)
        if: >-
          github.event_name == 'workflow_dispatch' && inputs.full_refresh == 'true'
        run: npx tsx src/scripts/collect-holidays.ts

      # ── Always: recalculate scores ─────────────────────────
      - name: Calculate scores
        run: npx tsx src/scripts/calculate-scores.ts

  # ── Manual-only: backfill historical exchange rates ────────
  backfill-exchange:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - run: npm ci

      - name: Backfill exchange rates
        run: npx tsx src/scripts/backfill-exchange.ts
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EXCHANGE_RATE_API_KEY: ${{ secrets.EXCHANGE_RATE_API_KEY }}
