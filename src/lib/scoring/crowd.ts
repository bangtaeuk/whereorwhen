import type { Score } from "@/types";

/**
 * 혼잡도 점수 계산 (PRD §4.4)
 *
 * 한국 공휴일 + 현지 공휴일 + 시즌 피크 반영
 * 점수가 높을수록 덜 혼잡함 (여행하기 좋음)
 */

/** 한국 공휴일/연휴 밀집도 (월별, 높을수록 여행 수요 높음 = 혼잡) */
const KOREAN_HOLIDAY_DENSITY: Record<number, number> = {
  1: 0.6, // 신정 + 겨울방학
  2: 0.7, // 설 연휴 + 겨울방학
  3: 0.3, // 비교적 한산
  4: 0.4, // 봄 시즌 시작
  5: 0.7, // 어린이날 + 석가탄신일 연휴
  6: 0.3, // 현충일(1일) 외 한산
  7: 0.8, // 여름휴가 시작
  8: 0.9, // 여름휴가 피크 + 광복절
  9: 0.6, // 추석
  10: 0.5, // 한글날 + 개천절
  11: 0.3, // 한산
  12: 0.6, // 연말 + 크리스마스
};

/**
 * 국가별 현지 피크 시즌 (월별 혼잡도 가중치)
 * 높을수록 현지가 혼잡
 */
const LOCAL_PEAK_SEASON: Record<string, Record<number, number>> = {
  JP: {
    1: 0.4, 2: 0.3, 3: 0.7, 4: 0.8, // 벚꽃 시즌
    5: 0.7, // 골든위크
    6: 0.3, 7: 0.6, 8: 0.7, // 오봉
    9: 0.4, 10: 0.5, 11: 0.6, // 단풍
    12: 0.5,
  },
  TH: {
    1: 0.6, 2: 0.5, 3: 0.4, 4: 0.7, // 송크란
    5: 0.3, 6: 0.2, 7: 0.2, 8: 0.2,
    9: 0.2, 10: 0.3, 11: 0.5, 12: 0.7, // 성수기
  },
  VN: {
    1: 0.5, 2: 0.6, // 뗏
    3: 0.3, 4: 0.3, 5: 0.3,
    6: 0.4, 7: 0.5, 8: 0.5, 9: 0.4,
    10: 0.3, 11: 0.4, 12: 0.5,
  },
  US: {
    1: 0.3, 2: 0.3, 3: 0.4, 4: 0.4,
    5: 0.5, 6: 0.7, 7: 0.8, // 독립기념일
    8: 0.7, 9: 0.4, 10: 0.4,
    11: 0.6, // 추수감사절
    12: 0.7, // 크리스마스
  },
  PH: {
    1: 0.5, 2: 0.4, 3: 0.5, 4: 0.6, // 성주간
    5: 0.4, 6: 0.3, 7: 0.3, 8: 0.3,
    9: 0.2, 10: 0.3, 11: 0.4, 12: 0.6,
  },
  TW: {
    1: 0.5, 2: 0.7, // 춘절
    3: 0.3, 4: 0.4, 5: 0.4,
    6: 0.4, 7: 0.5, 8: 0.5, 9: 0.4,
    10: 0.5, // 쌍십절
    11: 0.3, 12: 0.4,
  },
  SG: {
    1: 0.4, 2: 0.5, // 춘절
    3: 0.3, 4: 0.3, 5: 0.3,
    6: 0.5, 7: 0.5, 8: 0.5, 9: 0.4,
    10: 0.3, 11: 0.4, 12: 0.6,
  },
  HK: {
    1: 0.4, 2: 0.6, // 춘절
    3: 0.4, 4: 0.4, 5: 0.3,
    6: 0.4, 7: 0.5, 8: 0.5, 9: 0.4,
    10: 0.5, 11: 0.4, 12: 0.6,
  },
  ID: {
    1: 0.3, 2: 0.3, 3: 0.3, 4: 0.5, // 라마단/이드
    5: 0.4, 6: 0.4, 7: 0.6, // 건기 성수기
    8: 0.7, 9: 0.5, 10: 0.4, 11: 0.3, 12: 0.5,
  },
  MY: {
    1: 0.3, 2: 0.4, 3: 0.3, 4: 0.4,
    5: 0.4, 6: 0.5, 7: 0.5, 8: 0.5,
    9: 0.3, 10: 0.3, 11: 0.4, 12: 0.5,
  },
  FR: {
    1: 0.3, 2: 0.3, 3: 0.4, 4: 0.5,
    5: 0.5, 6: 0.7, 7: 0.9, // 여름 성수기
    8: 0.9, 9: 0.5, 10: 0.4, 11: 0.3, 12: 0.6,
  },
  GB: {
    1: 0.2, 2: 0.2, 3: 0.3, 4: 0.4,
    5: 0.5, 6: 0.7, 7: 0.8, 8: 0.8,
    9: 0.4, 10: 0.3, 11: 0.3, 12: 0.5,
  },
  ES: {
    1: 0.3, 2: 0.3, 3: 0.4, 4: 0.5,
    5: 0.5, 6: 0.7, 7: 0.9, 8: 0.9,
    9: 0.5, 10: 0.4, 11: 0.3, 12: 0.5,
  },
  AU: {
    1: 0.8, // 여름 성수기 (남반구)
    2: 0.6, 3: 0.4, 4: 0.4,
    5: 0.3, 6: 0.3, 7: 0.4, 8: 0.4,
    9: 0.4, 10: 0.4, 11: 0.5, 12: 0.7,
  },
};

/**
 * 혼잡도 점수 계산 (높을수록 한산 = 좋음)
 *
 * @param countryCode - ISO 국가 코드
 * @param month - 월 (1-12)
 * @returns Score (1.0 ~ 10.0)
 */
export function calculateCrowdScore(
  countryCode: string,
  month: number
): Score {
  const koreanDensity = KOREAN_HOLIDAY_DENSITY[month] ?? 0.5;
  const localPeak = LOCAL_PEAK_SEASON[countryCode]?.[month] ?? 0.5;

  // 혼잡도 = 한국 연휴(60%) + 현지 피크(40%)
  const crowdLevel = koreanDensity * 0.6 + localPeak * 0.4;

  // 혼잡도를 점수로 변환 (혼잡할수록 낮은 점수)
  // crowdLevel 0 → 10점, crowdLevel 1 → 1점
  const raw = 10 - crowdLevel * 9;
  return Math.round(Math.min(10, Math.max(1, raw)) * 10) / 10;
}
