# whereorwhen v2 — 리텐션 강화 기능 PRD

**작성일:** 2026-02-14
**버전:** 2.0
**상태:** Draft
**기반:** PRD v1.0 + Growth Department 세션 (2026-02-14)

---

## 1. 개요

### 1.1 배경

whereorwhen v1은 여행지별 최적 시기를 종합 점수로 제공하는 서비스로, "정확한 정보 제공"에 최적화되어 있음. 그러나 현재 점수 산출에 사용되는 데이터가 대부분 정적(30년 날씨 평균, 연간 공휴일)이어서 **점수 변동이 거의 없고, 사용자가 매일 방문할 이유가 부족함**.

| 현재 데이터 | 변동 주기 | 문제점 |
|------------|----------|--------|
| 날씨 (30년 평균) | 연 1회 | 같은 달은 항상 같은 점수 |
| 환율 | 일 1회 | 변동폭 작아 점수 변화 미미 |
| 공휴일 | 연 1회 | 해당 연도 내 고정 |
| 버즈 | 월 1회 | 월 단위로만 변동 |

### 1.2 v2 목표

**리텐션 강화를 위한 3가지 핵심 기능 추가:**

1. **오늘의 BEST 타이밍** — 매일 변하는 추천으로 일일 방문 유도
2. **실시간 날씨 예보 (7-14일)** — 동적 데이터로 즉각적 가치 제공
3. **내 여행 저장 + 알림** — 개인화 기반 재방문 유도

### 1.3 성공 지표

| 지표 | 현재 (예상) | v2 목표 | 측정 방법 |
|------|------------|---------|----------|
| D7 리텐션 | 10% | 25% | GA/Amplitude |
| D30 리텐션 | 3% | 15% | GA/Amplitude |
| 주간 재방문율 | 15% | 40% | GA |
| 저장 기능 사용률 | N/A | 30% | 이벤트 트래킹 |
| 알림 수신 동의율 | N/A | 50% | 이벤트 트래킹 |

---

## 2. 기능 1: 오늘의 BEST 타이밍

### 2.1 개요

매일 알고리즘이 **"오늘 예약하면 가장 좋은 여행지+시기 조합"**을 자동 추천하는 기능. 기존 데이터(환율, 날씨, 혼잡도, 버즈)를 조합하여 매일 다른 결과를 생성함.

### 2.2 핵심 가치

- **사용자:** "지금 예약하면 어디가 좋을지" 한눈에 파악
- **비즈니스:** 매일 변하는 콘텐츠로 일일 방문 습관 형성
- **차별화:** 경쟁 서비스에 없는 "오늘" 기준 추천

### 2.3 기능 상세

#### 2.3.1 메인 화면 노출

**위치:** 메인 화면 상단, 모드 전환 슬라이더 위

**레이아웃:**

| 영역 | 구성 |
|------|------|
| 헤더 | "오늘의 BEST 타이밍" + 날짜 (2026.02.14 기준) |
| 카드 1 | 1위 추천: 도시 + 추천 시기 + 종합 점수 + 핵심 이유 |
| 카드 2-3 | 2-3위 추천 (축약형) |
| CTA | "전체 랭킹 보기" → 상세 페이지 이동 |

**카드 예시:**

```
┌─────────────────────────────────────────────┐
│  🥇 오늘의 1위                              │
│  ┌───────┐                                  │
│  │ 다낭  │  4월 둘째주 (4/7 - 4/13)         │
│  │ 🇻🇳   │  종합 점수: 9.2                  │
│  └───────┘                                  │
│  ✓ 환율 3개월 내 최저점                     │
│  ✓ 건기 시작, 맑은 날 85%                   │
│  ✓ 한국 공휴일 없는 비수기                  │
│                                             │
│  [자세히 보기]  [이 여행 저장하기]          │
└─────────────────────────────────────────────┘
```

#### 2.3.2 추천 알고리즘

**입력:** 20개 도시 x 52주 = 1,040개 조합

**스코어링 공식:**

```
오늘의_점수 = 기본_종합점수
            + 환율_보너스
            + 예보_보너스
            + 시즌_보너스
            + 시의성_보너스
```

**각 보너스 상세:**

| 보너스 | 조건 | 점수 |
|--------|------|------|
| 환율_보너스 | 최근 3개월 내 최저점 | +1.0 |
| 환율_보너스 | 최근 1개월 내 최저점 | +0.5 |
| 예보_보너스 | 향후 14일 예보가 역사 평균보다 좋음 | +0.5 |
| 시즌_보너스 | 해당 도시의 시즌 시작 직전 (예: 벚꽃, 건기) | +0.5 |
| 시의성_보너스 | 추천 시기까지 4-8주 남음 (예약 적정 타이밍) | +0.3 |

**정렬:** 오늘의_점수 내림차순 → 상위 10개 노출

#### 2.3.3 갱신 주기

| 항목 | 주기 | 트리거 |
|------|------|--------|
| 환율 데이터 | 매일 09:00 KST | Cron job |
| 예보 데이터 | 매일 06:00 KST | Cron job |
| 오늘의 BEST 계산 | 매일 09:30 KST | 환율 갱신 후 |
| 캐시 무효화 | 매일 10:00 KST | ISR revalidate |

#### 2.3.4 "오늘의 BEST" 상세 페이지

**URL:** `/today` 또는 `/best-timing`

**구성:**

| 섹션 | 내용 |
|------|------|
| 헤더 | "2026년 2월 14일 기준 오늘의 BEST 타이밍" |
| TOP 10 리스트 | 1-10위 카드 (도시, 추천 시기, 점수, 이유) |
| 필터 | 지역별 (아시아/유럽/미주), 시기별 (1개월 내/3개월 내) |
| 히스토리 | "어제의 BEST", "지난주 BEST" 비교 (선택적) |

### 2.4 데이터 요구사항

**신규 데이터 없음** — 기존 v1 데이터 활용

**추가 계산:**
- 환율 3개월 이동평균 vs 현재 환율 비교
- 시즌 시작일 정의 (도시별 메타데이터)

**도시별 시즌 메타데이터 예시:**

| 도시 | 시즌명 | 시작일 | 종료일 |
|------|--------|--------|--------|
| 도쿄 | 벚꽃 | 3/20 | 4/10 |
| 도쿄 | 단풍 | 11/10 | 12/5 |
| 방콕 | 건기 | 11/1 | 2/28 |
| 다낭 | 건기 | 3/1 | 8/31 |
| 파리 | 봄 | 4/1 | 5/31 |

### 2.5 UI/UX 설계

**메인 화면 와이어프레임:**

```
┌────────────────────────────────────────────────┐
│  whereorwhen                                   │
├────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────┐    │
│  │     🏆 오늘의 BEST 타이밍              │    │
│  │     2026.02.14 기준                    │    │
│  │  ┌──────────────────────────────────┐  │    │
│  │  │  🥇 다낭 · 4월 둘째주 · 9.2점    │  │    │
│  │  │  환율 최저점 + 건기 시작          │  │    │
│  │  └──────────────────────────────────┘  │    │
│  │  🥈 오사카 8.8  🥉 세부 8.5          │    │
│  │              [전체 보기 →]             │    │
│  └────────────────────────────────────────┘    │
├────────────────────────────────────────────────┤
│  [Where → When]═══════○═══════[When → Where]   │
├────────────────────────────────────────────────┤
│  (기존 모드 A/B 영역)                          │
└────────────────────────────────────────────────┘
```

### 2.6 기술 구현

**API 엔드포인트:**

```
GET /api/today-best
Response:
{
  "date": "2026-02-14",
  "rankings": [
    {
      "rank": 1,
      "city": "danang",
      "cityName": "다낭",
      "country": "베트남",
      "recommendedPeriod": {
        "start": "2026-04-07",
        "end": "2026-04-13",
        "label": "4월 둘째주"
      },
      "score": 9.2,
      "baseScore": 8.2,
      "bonuses": {
        "exchangeRate": 0.5,
        "forecast": 0.3,
        "season": 0.2
      },
      "reasons": [
        "환율 3개월 내 최저점",
        "건기 시작, 맑은 날 85%",
        "한국 공휴일 없는 비수기"
      ]
    },
    // ... 2-10위
  ],
  "generatedAt": "2026-02-14T09:30:00+09:00"
}
```

**계산 로직 (pseudo-code):**

```javascript
async function calculateTodayBest() {
  const cities = await getCities(); // 20개 도시
  const weeks = getNext12Weeks(); // 향후 12주

  const combinations = [];

  for (const city of cities) {
    for (const week of weeks) {
      const baseScore = await getBaseScore(city, week);
      const exchangeBonus = calculateExchangeBonus(city);
      const forecastBonus = await calculateForecastBonus(city, week);
      const seasonBonus = calculateSeasonBonus(city, week);
      const timelinessBonus = calculateTimelinessBonus(week);

      combinations.push({
        city,
        week,
        score: baseScore + exchangeBonus + forecastBonus + seasonBonus + timelinessBonus,
        bonuses: { exchangeBonus, forecastBonus, seasonBonus, timelinessBonus }
      });
    }
  }

  return combinations
    .sort((a, b) => b.score - a.score)
    .slice(0, 10);
}
```

### 2.7 개발 일정

| 주차 | 태스크 | 담당 | 산출물 |
|------|--------|------|--------|
| W1 | 시즌 메타데이터 정의 | PM | 도시별 시즌 JSON |
| W1 | 보너스 알고리즘 구현 | Backend | calculateTodayBest() |
| W1 | API 엔드포인트 구현 | Backend | /api/today-best |
| W2 | 메인 화면 UI 구현 | Frontend | 오늘의 BEST 카드 |
| W2 | 상세 페이지 구현 | Frontend | /today 페이지 |
| W2 | Cron job 설정 | Backend | 일일 갱신 스케줄 |

**총 공수:** 2주

---

## 3. 기능 2: 실시간 날씨 예보 (7-14일)

### 3.1 개요

기존 30년 역사 평균 날씨에 더해, **향후 7-14일 실시간 예보**를 추가로 제공. 여행 예정자가 "지금 가면 날씨가 어떨지" 구체적으로 알 수 있음.

### 3.2 핵심 가치

- **사용자:** 실제 여행 날짜의 예상 날씨를 미리 확인
- **비즈니스:** 예보는 매일 바뀌므로 매일 확인할 이유 생김
- **차별화:** 역사 평균 + 실시간 예보 조합은 경쟁 서비스에 없음

### 3.3 기능 상세

#### 3.3.1 점수 상세 패널 개선

**기존 (v1):**
```
날씨 점수: 8.2
"맑은 날 75%, 평균 18°C" (30년 평균 기준)
```

**개선 (v2):**
```
날씨 점수: 8.2 → 8.5 ↑

📊 역사 평균 (30년)
   맑은 날 75%, 평균 18°C

🌤️ 이번 주 예보 (2/14-2/20)
   ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐
   │ 금  │ 토  │ 일  │ 월  │ 화  │ 수  │ 목  │
   │ ☀️  │ ☀️  │ ⛅  │ ☀️  │ ☀️  │ 🌧️  │ ☀️  │
   │ 19° │ 20° │ 18° │ 21° │ 22° │ 17° │ 20° │
   └─────┴─────┴─────┴─────┴─────┴─────┴─────┘
   맑은 날 6/7일 (86%) — 평균보다 좋음! ✓
```

#### 3.3.2 예보 점수 보정

실시간 예보가 역사 평균보다 좋거나 나쁘면 점수를 보정함.

**보정 로직:**

| 조건 | 보정 |
|------|------|
| 예보 맑은 날 비율 > 역사 평균 + 10%p | +0.3 ~ +0.5 |
| 예보 맑은 날 비율 ≈ 역사 평균 | 0 |
| 예보 맑은 날 비율 < 역사 평균 - 10%p | -0.3 ~ -0.5 |
| 예보에 태풍/폭우 경보 | -1.0 ~ -2.0 |

**예시:**
- 도쿄 4월: 역사 평균 맑은 날 70%
- 이번 주 예보: 맑은 날 85%
- → 날씨 점수 +0.3 보정

#### 3.3.3 "지금 가면" vs "N월에 가면" 구분

**모드 A (목적지 → 시기) 개선:**

| 시기 | 표시 내용 |
|------|----------|
| 향후 14일 이내 | 실시간 예보 기반 점수 (우선 표시) |
| 15일 이후 | 역사 평균 기반 점수 (기존과 동일) |

**UI 표시:**

```
┌─────────────────────────────────────────────┐
│  도쿄 · 2026년                              │
├─────────────────────────────────────────────┤
│  2월        [8.2] ← 실시간 예보 반영        │
│  ├ 2/14-2/20  8.5  🌤️ 예보: 맑음 86%       │
│  ├ 2/21-2/28  7.9  🌤️ 예보: 맑음 71%       │
│  3월        [7.5] ← 역사 평균               │
│  4월        [9.1] ← 역사 평균 (벚꽃 시즌)   │
│  ...                                        │
└─────────────────────────────────────────────┘
```

### 3.4 데이터 요구사항

#### 3.4.1 API 소스

**Open-Meteo Forecast API (무료)**

- Base URL: `https://api.open-meteo.com/v1/forecast`
- 파라미터: `latitude`, `longitude`, `daily`, `forecast_days=14`
- 응답: 일별 기온, 강수량, 날씨 코드
- 제한: 없음 (Fair use)

**요청 예시:**

```
GET https://api.open-meteo.com/v1/forecast
  ?latitude=35.6762
  &longitude=139.6503
  &daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode
  &forecast_days=14
  &timezone=Asia/Tokyo
```

**응답 예시:**

```json
{
  "daily": {
    "time": ["2026-02-14", "2026-02-15", ...],
    "temperature_2m_max": [12.3, 14.1, ...],
    "temperature_2m_min": [3.2, 5.1, ...],
    "precipitation_sum": [0.0, 0.0, 2.3, ...],
    "weathercode": [0, 1, 61, ...]
  }
}
```

**Weather Code 매핑:**

| 코드 | 의미 | 아이콘 | 맑음 여부 |
|------|------|--------|----------|
| 0 | 맑음 | ☀️ | Yes |
| 1, 2, 3 | 구름 조금/보통/많음 | ⛅ | Yes (1,2) / No (3) |
| 45, 48 | 안개 | 🌫️ | No |
| 51-57 | 이슬비 | 🌧️ | No |
| 61-67 | 비 | 🌧️ | No |
| 71-77 | 눈 | 🌨️ | No |
| 80-82 | 소나기 | 🌧️ | No |
| 95, 96, 99 | 뇌우 | ⛈️ | No |

#### 3.4.2 데이터 저장

| 데이터 | 저장 여부 | 갱신 주기 | TTL |
|--------|----------|----------|-----|
| 14일 예보 | 캐시 (Redis/메모리) | 6시간 | 6시간 |
| 예보 기반 보정 점수 | 캐시 | 6시간 | 6시간 |

**갱신 스케줄:**

```
06:00 KST - 전체 20개 도시 예보 갱신
12:00 KST - 전체 20개 도시 예보 갱신
18:00 KST - 전체 20개 도시 예보 갱신
00:00 KST - 전체 20개 도시 예보 갱신
```

### 3.5 UI/UX 설계

#### 3.5.1 점수 상세 패널 와이어프레임

```
┌─────────────────────────────────────────────────┐
│  도쿄 · 2월 셋째주 (2/14-2/20)                  │
│  종합 점수: 8.5                                 │
├─────────────────────────────────────────────────┤
│  🌤️ 날씨 점수: 8.5 (예보 반영)                 │
│  ┌─────────────────────────────────────────┐    │
│  │  이번 주 예보                           │    │
│  │  ┌───┬───┬───┬───┬───┬───┬───┐         │    │
│  │  │금 │토 │일 │월 │화 │수 │목 │         │    │
│  │  │☀️ │☀️ │⛅│☀️ │☀️ │🌧️│☀️ │         │    │
│  │  │19°│20°│18°│21°│22°│17°│20°│         │    │
│  │  └───┴───┴───┴───┴───┴───┴───┘         │    │
│  │  맑은 날 6/7 (86%) · 평균 19°C          │    │
│  │  ✓ 역사 평균(75%)보다 좋음              │    │
│  └─────────────────────────────────────────┘    │
│                                                 │
│  📊 역사 평균 (30년)                            │
│  맑은 날 75%, 평균 기온 12-18°C                 │
├─────────────────────────────────────────────────┤
│  💰 비용 점수: 7.8                              │
│  ...                                            │
└─────────────────────────────────────────────────┘
```

#### 3.5.2 14일 이내 표시 배지

향후 14일 이내 시기에는 "실시간 예보" 배지 표시:

```
┌──────────────────────┐
│  2월 셋째주          │
│  [8.5] 🔴 실시간예보 │
└──────────────────────┘
```

### 3.6 기술 구현

**API 엔드포인트:**

```
GET /api/forecast?city=tokyo
Response:
{
  "city": "tokyo",
  "forecast": [
    {
      "date": "2026-02-14",
      "tempMax": 12.3,
      "tempMin": 3.2,
      "precipitation": 0.0,
      "weatherCode": 0,
      "weatherIcon": "☀️",
      "isClear": true
    },
    // ... 14일
  ],
  "summary": {
    "clearDays": 10,
    "totalDays": 14,
    "clearRatio": 0.71,
    "avgTemp": 15.2,
    "historicalClearRatio": 0.65,
    "comparisonToHistorical": "better" // "better" | "similar" | "worse"
  },
  "scoreAdjustment": 0.3,
  "fetchedAt": "2026-02-14T06:00:00+09:00"
}
```

**예보 수집 배치:**

```javascript
// cron: 0 6,12,18,0 * * *
async function fetchAllForecasts() {
  const cities = await getCities();

  for (const city of cities) {
    const forecast = await fetchFromOpenMeteo(city.lat, city.lng);
    await cacheForecast(city.id, forecast, TTL_6_HOURS);
  }

  // 점수 보정 재계산
  await recalculateScoresWithForecast();
}
```

### 3.7 개발 일정

| 주차 | 태스크 | 담당 | 산출물 |
|------|--------|------|--------|
| W1 | Open-Meteo API 연동 | Backend | fetchForecast() |
| W1 | 예보 캐싱 로직 | Backend | Redis/메모리 캐시 |
| W1 | 점수 보정 알고리즘 | Backend | calculateForecastBonus() |
| W2 | 점수 상세 패널 UI 개선 | Frontend | 예보 표시 컴포넌트 |
| W2 | 14일 이내 배지 표시 | Frontend | 실시간예보 배지 |
| W2 | Cron job 설정 (6시간 간격) | Backend | 예보 갱신 스케줄 |

**총 공수:** 2주

---

## 4. 기능 3: 내 여행 저장 + 알림

### 4.1 개요

사용자가 관심 있는 **도시+시기 조합을 저장**하고, 점수가 유의미하게 변하면 **푸시/이메일로 알림**을 받는 기능. 개인화 기반 리텐션의 핵심 메커니즘.

### 4.2 핵심 가치

- **사용자:** 여러 옵션을 저장해두고 비교, 최적 타이밍에 알림 수신
- **비즈니스:** 저장 데이터로 사용자 의도 파악, 알림으로 재방문 유도
- **차별화:** "점수 변동 알림"은 경쟁 서비스에 없음

### 4.3 기능 상세

#### 4.3.1 저장 기능

**저장 대상:**
- 도시 + 시기 (주 단위) 조합
- 예: "도쿄 4월 첫째주", "다낭 3월 전체"

**저장 방식:**
- 비로그인: 로컬스토리지 (기기 한정)
- 로그인: 서버 저장 (기기 간 동기화)

**저장 개수 제한:**
- 비로그인: 5개
- 로그인: 20개

**UI:**

점수 카드/상세 패널에 "저장" 버튼:

```
┌─────────────────────────────────────────────┐
│  도쿄 · 4월 첫째주                          │
│  종합 점수: 9.1                             │
│                                             │
│  [자세히 보기]  [♡ 저장하기]                │
└─────────────────────────────────────────────┘
```

저장 후:

```
│  [자세히 보기]  [♥ 저장됨 ✓]                │
```

#### 4.3.2 내 저장 목록

**URL:** `/my-trips` 또는 `/saved`

**레이아웃:**

```
┌─────────────────────────────────────────────────┐
│  내 저장 여행                                   │
│  3개 저장됨                                     │
├─────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────┐  │
│  │  🇯🇵 도쿄 · 4월 첫째주                    │  │
│  │  점수: 9.1 (저장 시 9.0 → +0.1 ↑)        │  │
│  │  💬 "벚꽃 시즌 시작, 환율 안정"          │  │
│  │  [상세보기] [알림설정] [삭제]             │  │
│  └───────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────┐  │
│  │  🇻🇳 다낭 · 3월 전체                      │  │
│  │  점수: 8.7 (저장 시 8.5 → +0.2 ↑)        │  │
│  │  🔔 알림 ON: 9.0점 이상 시 알림           │  │
│  │  [상세보기] [알림설정] [삭제]             │  │
│  └───────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────┐  │
│  │  🇹🇭 방콕 · 2월 셋째주                    │  │
│  │  점수: 7.2 (저장 시 7.5 → -0.3 ↓)        │  │
│  │  ⚠️ 점수 하락: 환율 상승                  │  │
│  │  [상세보기] [알림설정] [삭제]             │  │
│  └───────────────────────────────────────────┘  │
├─────────────────────────────────────────────────┤
│  [+ 새 여행 추가]                               │
└─────────────────────────────────────────────────┘
```

#### 4.3.3 알림 설정

**알림 유형:**

| 유형 | 설명 | 트리거 |
|------|------|--------|
| 점수 변동 알림 | 저장한 여행의 점수가 유의미하게 변동 | 점수 ±0.5 이상 변동 |
| 목표 점수 도달 | 사용자가 설정한 목표 점수 도달 | 점수 >= 목표 |
| 최적 타이밍 알림 | 저장한 여행이 "오늘의 BEST"에 진입 | TOP 10 진입 |
| 예약 타이밍 리마인더 | 저장한 시기 4주 전 리마인더 | D-28 |

**알림 설정 UI:**

```
┌─────────────────────────────────────────────────┐
│  알림 설정: 도쿄 4월 첫째주                     │
├─────────────────────────────────────────────────┤
│  🔔 점수 변동 알림                              │
│  점수가 크게 변하면 알려드려요                  │
│  [ON ●───────]                                  │
│                                                 │
│  🎯 목표 점수 알림                              │
│  설정한 점수에 도달하면 알려드려요              │
│  목표 점수: [9.5] 이상                          │
│  [ON ●───────]                                  │
│                                                 │
│  🏆 BEST 진입 알림                              │
│  "오늘의 BEST"에 진입하면 알려드려요            │
│  [OFF ───────●]                                 │
│                                                 │
│  ⏰ 예약 타이밍 리마인더                        │
│  여행 4주 전에 리마인더를 보내드려요            │
│  [ON ●───────]                                  │
├─────────────────────────────────────────────────┤
│  알림 수신 방법                                 │
│  ☑️ 푸시 알림 (브라우저)                        │
│  ☑️ 이메일 (user@email.com)                    │
├─────────────────────────────────────────────────┤
│  [저장]                                         │
└─────────────────────────────────────────────────┘
```

#### 4.3.4 알림 메시지 템플릿

**푸시 알림:**

| 유형 | 제목 | 본문 |
|------|------|------|
| 점수 상승 | "도쿄 4월 점수 UP! 🎉" | "9.0 → 9.3 (+0.3) 환율 하락으로 비용 점수 상승" |
| 점수 하락 | "방콕 2월 점수 변동 📉" | "7.5 → 7.2 (-0.3) 예보상 비 예상" |
| 목표 도달 | "목표 달성! 다낭 9.0점 돌파 🎯" | "설정한 목표 점수에 도달했어요. 지금이 예약 타이밍!" |
| BEST 진입 | "도쿄가 오늘의 BEST 3위! 🏆" | "저장한 도쿄 4월이 오늘의 추천 3위에 올랐어요" |
| 리마인더 | "도쿄 여행 4주 전! ⏰" | "저장한 도쿄 4월 첫째주까지 4주 남았어요" |

**이메일:**

```
제목: [whereorwhen] 도쿄 4월 점수가 9.3으로 올랐어요!

안녕하세요,

저장하신 "도쿄 4월 첫째주" 점수가 변동되었어요.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 도쿄 · 4월 첫째주 (4/1 - 4/7)
점수: 9.0 → 9.3 (+0.3 ↑)

변동 이유:
• 환율: 엔화 3개월 내 최저점 도달
• 날씨: 벚꽃 시즌 예보 맑음
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[상세 보기] [알림 설정 변경]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
whereorwhen - 여행 최적 시기를 알려드려요
알림 수신을 원하지 않으시면 [수신거부]
```

### 4.4 데이터 요구사항

#### 4.4.1 데이터 모델

**SavedTrip (저장된 여행):**

```typescript
interface SavedTrip {
  id: string;
  userId: string | null; // 비로그인 시 null
  deviceId: string; // 비로그인 시 사용
  city: string;
  period: {
    type: 'week' | 'month';
    year: number;
    month: number;
    week?: number; // 1-5
  };
  savedAt: Date;
  scoreAtSave: number;
  currentScore: number;
  notifications: NotificationSettings;
}

interface NotificationSettings {
  scoreChange: boolean;
  targetScore: number | null;
  bestEntry: boolean;
  reminder: boolean;
  channels: {
    push: boolean;
    email: boolean;
  };
}
```

**NotificationLog (알림 이력):**

```typescript
interface NotificationLog {
  id: string;
  savedTripId: string;
  type: 'score_up' | 'score_down' | 'target_reached' | 'best_entry' | 'reminder';
  sentAt: Date;
  channel: 'push' | 'email';
  status: 'sent' | 'failed' | 'clicked';
}
```

#### 4.4.2 저장소

| 데이터 | 저장소 | 이유 |
|--------|--------|------|
| SavedTrip (로그인) | PostgreSQL/Supabase | 영구 저장, 기기 간 동기화 |
| SavedTrip (비로그인) | LocalStorage | 서버 부하 없이 저장 |
| NotificationLog | PostgreSQL | 알림 이력 분석 |
| 푸시 구독 정보 | PostgreSQL | Web Push 발송용 |

### 4.5 알림 시스템 아키텍처

#### 4.5.1 알림 트리거 플로우

```
┌──────────────────────────────────────────────────────────┐
│                      Daily Score Update                  │
│                    (매일 09:30 KST)                      │
└──────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────┐
│                  Compare Scores Job                      │
│  • 각 SavedTrip의 currentScore vs 새로운 점수 비교      │
│  • 변동폭 >= 0.5 인 경우 알림 대상으로 마킹             │
└──────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────┐
│                  Notification Queue                      │
│  • 알림 대상 SavedTrip 목록                             │
│  • 알림 유형별 분류                                     │
└──────────────────────────────────────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              ▼                           ▼
┌──────────────────────┐    ┌──────────────────────┐
│     Push Sender      │    │    Email Sender      │
│  • Web Push API      │    │  • SendGrid/SES      │
│  • FCM (향후 앱)     │    │  • 템플릿 렌더링     │
└──────────────────────┘    └──────────────────────┘
              │                           │
              └─────────────┬─────────────┘
                            ▼
┌──────────────────────────────────────────────────────────┐
│                  NotificationLog 저장                    │
└──────────────────────────────────────────────────────────┘
```

#### 4.5.2 Web Push 구현

**브라우저 푸시 구독:**

```javascript
// Frontend: 푸시 권한 요청 및 구독
async function subscribeToPush() {
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') return;

  const registration = await navigator.serviceWorker.ready;
  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: VAPID_PUBLIC_KEY
  });

  // 서버에 구독 정보 저장
  await fetch('/api/push/subscribe', {
    method: 'POST',
    body: JSON.stringify(subscription)
  });
}
```

**서버 푸시 발송:**

```javascript
// Backend: web-push 라이브러리 사용
import webpush from 'web-push';

webpush.setVapidDetails(
  'mailto:admin@whereorwhen.com',
  VAPID_PUBLIC_KEY,
  VAPID_PRIVATE_KEY
);

async function sendPushNotification(subscription, payload) {
  await webpush.sendNotification(subscription, JSON.stringify(payload));
}
```

### 4.6 UI/UX 설계

#### 4.6.1 저장 버튼 상태

```
[저장 전]     [저장 중]     [저장 완료]    [저장 해제]
 ♡ 저장     ⏳ 저장 중...   ♥ 저장됨       ♡ 저장
```

#### 4.6.2 로그인 유도

비로그인 상태에서 5개 초과 저장 시:

```
┌─────────────────────────────────────────────────┐
│  저장 개수가 가득 찼어요!                       │
│                                                 │
│  로그인하면:                                    │
│  ✓ 최대 20개까지 저장                          │
│  ✓ 기기 간 동기화                              │
│  ✓ 이메일 알림 수신                            │
│                                                 │
│  [로그인하기] [괜찮아요]                        │
└─────────────────────────────────────────────────┘
```

#### 4.6.3 알림 권한 요청

첫 저장 시 알림 권한 요청:

```
┌─────────────────────────────────────────────────┐
│  🔔 알림을 받으시겠어요?                        │
│                                                 │
│  저장한 여행의 점수가 변하면                    │
│  알림으로 알려드려요.                           │
│                                                 │
│  [알림 허용] [나중에]                           │
└─────────────────────────────────────────────────┘
```

### 4.7 기술 구현

**API 엔드포인트:**

```
# 저장
POST /api/saved-trips
Request: { city, period, notificationSettings }
Response: { id, savedTrip }

# 목록 조회
GET /api/saved-trips
Response: { trips: [...] }

# 삭제
DELETE /api/saved-trips/:id

# 알림 설정 변경
PATCH /api/saved-trips/:id/notifications
Request: { scoreChange, targetScore, ... }

# 푸시 구독
POST /api/push/subscribe
Request: { subscription }

# 푸시 구독 해제
DELETE /api/push/subscribe
```

### 4.8 개발 일정

| 주차 | 태스크 | 담당 | 산출물 |
|------|--------|------|--------|
| W1 | DB 스키마 설계 | Backend | SavedTrip, NotificationLog 테이블 |
| W1 | 저장 API 구현 | Backend | CRUD endpoints |
| W1 | LocalStorage 저장 (비로그인) | Frontend | useLocalStorage hook |
| W2 | 저장 버튼 UI | Frontend | SaveButton 컴포넌트 |
| W2 | 내 저장 목록 페이지 | Frontend | /my-trips 페이지 |
| W3 | 알림 설정 UI | Frontend | NotificationSettings 컴포넌트 |
| W3 | Web Push 구현 | Backend + Frontend | 푸시 구독/발송 |
| W3 | 이메일 발송 (SendGrid) | Backend | 이메일 템플릿 |
| W4 | 점수 비교 배치 job | Backend | compareScoresJob |
| W4 | 알림 발송 job | Backend | sendNotificationsJob |
| W4 | 알림 이력 대시보드 | Frontend | 관리자용 (선택) |

**총 공수:** 4주

---

## 5. 통합 아키텍처

### 5.1 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (Next.js)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 오늘의BEST │  │  예보 표시  │  │  저장 + 알림 설정       │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API Routes (Next.js)                       │
│  /api/today-best   /api/forecast   /api/saved-trips   /api/push │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
┌─────────────────┐  ┌─────────────┐  ┌─────────────────────────┐
│   Open-Meteo    │  │   Cache     │  │      Database           │
│  Forecast API   │  │ (Redis/KV)  │  │  (Supabase/PostgreSQL)  │
└─────────────────┘  └─────────────┘  └─────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Cron Jobs (Vercel/GitHub Actions)          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  06:00 - Forecast 갱신                                  │    │
│  │  09:00 - 환율 갱신                                      │    │
│  │  09:30 - 오늘의 BEST 계산 + 점수 비교 + 알림 발송      │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐    ┌─────────────────────────────────┐
│       Web Push          │    │         Email (SendGrid)        │
│    (VAPID/web-push)     │    │                                 │
└─────────────────────────┘    └─────────────────────────────────┘
```

### 5.2 일일 배치 스케줄

| 시간 (KST) | Job | 의존성 |
|------------|-----|--------|
| 06:00 | 예보 데이터 수집 (20개 도시) | Open-Meteo API |
| 09:00 | 환율 데이터 수집 | ExchangeRate API |
| 09:30 | 오늘의 BEST 계산 | 예보 + 환율 완료 후 |
| 09:35 | 저장된 여행 점수 비교 | 오늘의 BEST 완료 후 |
| 09:40 | 알림 발송 (점수 변동, 목표 도달) | 점수 비교 완료 후 |
| 10:00 | ISR 캐시 무효화 | 모든 계산 완료 후 |

---

## 6. 전체 개발 일정

| 주차 | 기능 1: 오늘의 BEST | 기능 2: 예보 | 기능 3: 저장+알림 |
|------|---------------------|--------------|-------------------|
| W1 | 알고리즘 + API | API 연동 + 캐싱 | DB 스키마 + API |
| W2 | UI 구현 | UI 개선 | UI 구현 (저장) |
| W3 | - | - | 알림 설정 + Push |
| W4 | - | - | 배치 job + 이메일 |
| W5 | 통합 테스트 | 통합 테스트 | 통합 테스트 |
| W6 | 베타 런칭 | 베타 런칭 | 베타 런칭 |

**총 개발 기간:** 6주

**리소스:**
- Backend: 1명 (풀타임)
- Frontend: 1명 (풀타임)
- Design: 0.5명 (W1-W3)

---

## 7. 리스크 및 대응

| 리스크 | 영향도 | 대응 |
|--------|--------|------|
| Open-Meteo API 장애 | 중 | 캐시된 예보 사용 (최대 6시간 전 데이터) |
| 푸시 알림 권한 거부율 높음 | 중 | 이메일 알림 폴백, 인앱 알림 추가 |
| 저장 기능 남용 (스팸) | 낮음 | Rate limiting, 저장 개수 제한 |
| 알림 피로도 | 중 | 알림 빈도 제한 (같은 여행 1일 1회), 쉬운 해제 |
| 비로그인 데이터 유실 | 낮음 | 로그인 유도 UI, 데이터 마이그레이션 기능 |

---

## 8. 향후 확장 (v3 이후)

| 기능 | 설명 | 우선순위 |
|------|------|----------|
| 항공권 가격 트래킹 | 최저가 알림, 가격 추이 그래프 | 높음 |
| 이벤트/축제 캘린더 | 도시별 이벤트 자동 수집 | 중 |
| 비교 기능 | 날짜 vs 날짜, 도시 vs 도시 비교 | 중 |
| 마리트 연동 | 점수 상세에서 마리트 예약 링크 | 높음 |
| 앱 알림 (FCM) | 네이티브 앱 출시 시 | 낮음 |

---

## 9. 성공 지표 측정 계획

### 9.1 런칭 후 1주

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| "오늘의 BEST" 클릭률 | 30%+ | 메인 화면 방문자 대비 |
| 예보 상세 조회율 | 40%+ | 점수 상세 패널 오픈 대비 |
| 저장 기능 사용률 | 20%+ | 전체 방문자 대비 |

### 9.2 런칭 후 1개월

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| D7 리텐션 | 25%+ | Amplitude |
| 주간 재방문율 | 40%+ | GA |
| 알림 수신 동의율 | 50%+ | 저장 유저 대비 |
| 알림 클릭률 | 15%+ | 알림 발송 대비 |

### 9.3 A/B 테스트 계획

| 테스트 | 가설 | 지표 |
|--------|------|------|
| 오늘의 BEST 위치 | 상단 노출 vs 하단 노출 → 상단이 클릭률 높음 | CTR |
| 알림 타이밍 | 아침 vs 저녁 → 저녁이 클릭률 높음 | 알림 클릭률 |
| 저장 버튼 문구 | "저장" vs "관심여행 추가" → ? | 저장률 |

---

**다음 단계:** 디자인 목업 작성 → 기술 스펙 상세화 → 스프린트 플래닝

---

*Last updated: 2026-02-14*
*Author: Growth Department Session*
